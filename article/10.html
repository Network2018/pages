<!-- build time:Sat May 05 2018 01:46:54 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><link href="https://static.sometimesnaive.org:9004/deps/imgs/favicon.ico" type="image/x-icon" rel="icon"><title>Content Security Policy 概述 | 南琴浪博客</title><link href="https://static.sometimesnaive.org:9004/deps/css/style.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/jquery.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/nprogress.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/nprogress.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/prism.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/prism.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/gitment.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/gitment.min.js" type="application/javascript"></script></head><body><header class="header fixed-header"><div class="header-container"><a class="home-link" href="/">南琴浪博客</a><ul class="right-list"><li class="list-item"><a href="/" class="item-link">Home</a></li><li class="list-item"><a href="/archive/" class="item-link">Archive</a></li><li class="list-item"><a href="/portal/atom.xml" class="item-link">RSS</a></li><li class="list-item"><a href="/portal/friendly-links" class="item-link">Links</a></li></ul><div class="menu-mask"><ul class="menu-list"><li class="menu-item"><a href="/" class="menu-link">Home</a></li><li class="menu-item"><a href="/archive/" class="menu-link">Archive</a></li><li class="menu-item"><a href="/portal/atom.xml" class="menu-link">RSS</a></li><li class="menu-item"><a href="/portal/friendly-links" class="menu-link">Links</a></li></ul></div></div></header><div id="article-banner"><h2>Content Security Policy 概述</h2><p class="post-date">10/15/2017</p></div><main class="app-body flex-box"><article class="post-article"><section class="markdown-content"><p>内容安全策略（Content Security Policy），简称 CSP，顾名思义了，是一种针对内容安全方面的保护策略。作用是<code>用来定义页面中哪些资源可以加载，以减少 XSS 的发生</code>。</p><p>Chrome 25+ 和 Firefox 23+ 已经加入对 CSP 的支持，其它浏览器的支持起步较晚，不过现在的浏览器已经较普遍的支持了。浏览器的具体支持情况可以参看 <a href="https://caniuse.com/#feat=contentsecuritypolicy" rel="external nofollow noopener noreferrer" target="_blank">CanIUse</a>。<br><a id="more"></a></p><h2 id="什么是-XSS-攻击"><a href="#什么是-XSS-攻击" class="headerlink" title="什么是 XSS 攻击"></a>什么是 XSS 攻击</h2><p>跨站脚本（英语：Cross-site scripting，通常简称为：XSS）是一种网站应用程序的安全漏洞攻击，是代码注入的一种。它允许恶意用户将代码注入到网页上，其他用户在观看网页时就会受到影响。这类攻击通常包含了 HTML 以及用户端脚本语言。</p><p>跨域脚本攻击（XSS 攻击）通常指的是通过利用网页开发时留下的漏洞，通过巧妙的方法注入恶意指令代码到网页，使用户加载并执行攻击者恶意制造的网页程序。这些恶意网页程序通常是 JavaScript，但实际上也可以包括 Java，VBScript，ActiveX，Flash 甚至是普通的 HTML。攻击成功后，攻击者可能得到更高的权限（如执行一些操作）、私密网页、会话和 cookie 等各种内容。</p><p>为了防止它，要采取很多编程对策，成本较高。很多人发出呼声，能不能<code>让浏览器自己禁止外部注入恶意脚本</code>呢？这时，CSP 应运而生。</p><h2 id="什么是-CSP"><a href="#什么是-CSP" class="headerlink" title="什么是 CSP"></a>什么是 CSP</h2><p>上文已提到，CSP 定义了页面中哪些资源可以加载。</p><p>所以 <code>CSP 的实质就是白名单</code>，Web 端明确地告诉客户端，只有哪些外部资源可以加载可以执行，相当于提供一份白名单，“我的规则里没提到的全部拜拜，不给进来”。</p><p>因此 CSP 大大增强了网页的安全性。即使攻击者发现可趁之机，也没法注入脚本。</p><h2 id="CSP-的两种启用方式"><a href="#CSP-的两种启用方式" class="headerlink" title="CSP 的两种启用方式"></a>CSP 的两种启用方式</h2><p>两种方法启用 CSP ：</p><p>一种是使用网页的 <code>&lt;meta&gt;</code> 标签</p><pre><code class="language-html">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src ${value}; script-src ${value}; style-src ${value}; img-src ${value}; font-src ${value}; media-src ${value}; object-src ${value}; connect-src ${value}; child-src ${value}; sandbox ${value}; report-uri ${value}&quot;&gt;
</code></pre><p>一种是使用 <code>HTTP 响应头</code></p><pre><code class="language-http">Content-Security-Policy: &quot;default-src ${value}; script-src ${value}; style-src ${value}; img-src ${value}; font-src ${value}; media-src ${value}; object-src ${value}; connect-src ${value}; child-src ${value}; sandbox ${value}; report-uri ${value}&quot;
</code></pre><p>若要在 Nginx 中配置：</p><pre><code class="language-nginx">add_header Content-Security-Policy &quot;default-src ${value}; script-src ${value}; style-src ${value}; img-src ${value}; font-src ${value}; media-src ${value}; object-src ${value}; connect-src ${value}; child-src ${value}; sandbox ${value}; report-uri ${value}&quot;;
</code></pre><p>以上，例如 script-src 等等是<code>参数项</code>，${value} 是<code>参数值</code>。因为 CSP 是白名单机制，所以 <code>参数项都是可选项</code>。</p><p>一、<code>参数项</code>的定义见下表：</p><table><thead><tr><th style="text-align:left">参数</th><th style="text-align:left">定义</th></tr></thead><tbody><tr><td style="text-align:left">default-src</td><td style="text-align:left">所有类型资源的默认加载策略。若某类型资源有单独定义加载策略就使用单独的，反之跟随 default-src 的值</td></tr><tr><td style="text-align:left">script-src</td><td style="text-align:left">JavaScript 的加载策略</td></tr><tr><td style="text-align:left">style-src</td><td style="text-align:left">样式的加载策略</td></tr><tr><td style="text-align:left">img-src</td><td style="text-align:left">图片的加载策略</td></tr><tr><td style="text-align:left">font-src</td><td style="text-align:left">WebFont 的加载策略</td></tr><tr><td style="text-align:left">media-src</td><td style="text-align:left">&lt;audio&gt; &lt;video&gt; 等标签引入的 HTML 多媒体的加载策略</td></tr><tr><td style="text-align:left">object-src</td><td style="text-align:left">&lt;object&gt; &lt;embed&gt; &lt;applet&gt; 等标签引入的 flash 等插件的加载策略</td></tr><tr><td style="text-align:left">connect-src</td><td style="text-align:left">Ajax、WebSocket 等请求的加载策略。若策略的值为不允许，浏览器会模拟一个状态 400 的响应</td></tr><tr><td style="text-align:left">child-src</td><td style="text-align:left">frame 的加载策略</td></tr><tr><td style="text-align:left">sandbox</td><td style="text-align:left">对请求的资源启用 sandbox。参数值只能为 “allow-forms” 或 “‘none’”</td></tr><tr><td style="text-align:left">report-uri</td><td style="text-align:left">告诉浏览器，若请求的资源不被 CSP 策略允许时，往哪个地址提交日志信息</td></tr></tbody></table><p>二、<code>值</code>的定义见下表：</p><table><thead><tr><th style="text-align:left">参数值</th><th style="text-align:left">定义</th></tr></thead><tbody><tr><td style="text-align:left"></td><td style="text-align:left">允许任何内容</td></tr><tr><td style="text-align:left">‘none’</td><td style="text-align:left">不允许任何内容</td></tr><tr><td style="text-align:left">‘self’</td><td style="text-align:left">允许来自相同来源（相同的域名、端口、协议）的内容</td></tr><tr><td style="text-align:left">example.example.org</td><td style="text-align:left">允许加载指定域名的资源</td></tr><tr><td style="text-align:left">*.example.org</td><td style="text-align:left">允许加载 example.org 任何子域名的资源</td></tr><tr><td style="text-align:left">https://example.example.org</td><td style="text-align:left">允许加载指定域名的 HTTPS 协议的资源</td></tr><tr><td style="text-align:left">https:</td><td style="text-align:left">允许加载 HTTPS 资源</td></tr><tr><td style="text-align:left">data:</td><td style="text-align:left">允许 data: 协议</td></tr><tr><td style="text-align:left">‘unsafe-inline’</td><td style="text-align:left">用于 script-src。允许加载 inline 资源（例如常见的 style 属性、onclick、inline js、inline css 等</td></tr><tr><td style="text-align:left">‘unsafe-eval’</td><td style="text-align:left">用于 script-src。允许加载动态 js 代码，例如 eval、setTimeout、new Function 等</td></tr></tbody></table><p>以上可以看到，CSP 可以控制的内容非常之多。</p><p>如果不指定 ‘unsafe-inline’ ，页面上所有 inline 样式都不会执行；不指定 ‘unsafe-eval’，页面上所有 eval 等动态代码都不会执行。</p><p>在限制页面资源加载后，被 XSS 的可能性小了不少。</p><p>当然，仅仅靠 CSP 来防范 XSS 显然远远不够。但它成本低，用起来方便啊。</p><p>若担心造成大的负面作用，可以先令其它各项策略都为不允许，<code>只写上 report-uri 以收集日志</code>：</p><pre><code class="language-http">Content-Security-Policy: default-src &#39;none&#39;; report-uri https://example.com/report.php
</code></pre><p>那么，这篇文章就介绍到这了。<br>现在的浏览器已经有了许多安全相关响应头的支持，更多详细请看我的另一篇帖子 <a href="https://sometimesnaive.org/article/9" rel="external nofollow noopener noreferrer" target="_blank">那些站点安全相关的 HTTP 响应头</a></p></section><br><div class="article-footer"><br><p>本文可能过时失效，若需更新，请留言</p><p>本博客文章均为原创，转载请注明来源</p></div><div class="nav-container"><a class="nav-right" href="/article/9.html">常用的访问安全 HTTP 响应头 <span class="nav-arrow">→</span> </a><a class="nav-left" href="/article/11.html"><span class="nav-arrow">← </span>通过 Zoho Mail 创建自己的 Gmail 域名邮箱</a></div><div id="comments"></div></article><aside class="catalog-container"><div class="toc-main"><strong class="toc-title">Catalog</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#什么是-XSS-攻击"><span class="toc-nav-text">什么是 XSS 攻击</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#什么是-CSP"><span class="toc-nav-text">什么是 CSP</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#CSP-的两种启用方式"><span class="toc-nav-text">CSP 的两种启用方式</span></a></li></ol></div></aside></main><script>!function(){var e="https://static.sometimesnaive.org:9004/deps/imgs/banner.jpg";$("#article-banner").css({"background-image":"url("+e+")"}),$(".header").removeClass("fixed-header")}()</script><script>(function(){
    var gitmentConfig = "nanqinlang"
    if (gitmentConfig !== 'undefined') {
        var gitment = new Gitment({
            id: "10",
            owner: "nanqinlang",
            repo: "sometimesnaive.org",
            oauth: {client_id: "b0612de512484ab34c7a", client_secret: "c2bc4cd3c947097d2ccc4c16f120d50458314dd0"},
            theme: {render(state, instance){const container = document.createElement('div');container.lang="en-US";container.className='gitment-container gitment-root-container';container.appendChild(instance.renderHeader(state, instance));container.appendChild(instance.renderEditor(state, instance));container.appendChild(instance.renderComments(state, instance));container.appendChild(instance.renderFooter(state, instance));return container;}}
        })
        gitment.render(document.getElementById('comments'))
    }
})();</script><div class="scroll-top"><span class="arrow-icon"></span></div><footer class="app-footer"><p class="copyright" align="center">&copy; 2017 - 2018 南琴浪博客 <a>(sometimesnaive.org)<a></a></a></p></footer><script src="https://static.sometimesnaive.org:9004/deps/js/function.min.js" type="application/javascript"></script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-108266909-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js" type="application/javascript"></script></body></html><!-- rebuild by neat -->