<!-- build time:Thu May 03 2018 22:55:48 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><link href="https://static.sometimesnaive.org:9004/deps/imgs/favicon.ico" type="image/x-icon" rel="icon"><title>Nginx 启用 OCSP Stapling | 南琴浪博客</title><link href="https://static.sometimesnaive.org:9004/deps/css/style.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/jquery.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/nprogress.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/nprogress.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/prism.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/prism.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/gitment.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/gitment.min.js" type="application/javascript"></script></head><body><header class="header fixed-header"><div class="header-container"><a class="home-link" href="/">南琴浪博客</a><ul class="right-list"><li class="list-item"><a href="/" class="item-link">Home</a></li><li class="list-item"><a href="/archive/" class="item-link">Archive</a></li><li class="list-item"><a href="/portal/atom.xml" class="item-link">RSS</a></li><li class="list-item"><a href="/portal/friendly-links" class="item-link">Links</a></li></ul><div class="menu-mask"><ul class="menu-list"><li class="menu-item"><a href="/" class="menu-link">Home</a></li><li class="menu-item"><a href="/archive/" class="menu-link">Archive</a></li><li class="menu-item"><a href="/portal/atom.xml" class="menu-link">RSS</a></li><li class="menu-item"><a href="/portal/friendly-links" class="menu-link">Links</a></li></ul></div></div></header><div id="article-banner"><h2>Nginx 启用 OCSP Stapling</h2><p class="post-date">10/24/2017</p></div><main class="app-body flex-box"><article class="post-article"><section class="markdown-content"><p>这里，我将介绍什么是 OCSP Stapling 以及为什么要开启它。<br><a id="more"></a></p><p>在线证书状态协议（Online Certificate Status Protocol），简称 OCSP，是一个用于获取 X.509 数字证书撤销状态的网际协议，在 RFC 6960 中定义。OCSP 用于检验证书合法性，查询服务一般由证书所属 CA 提供。OCSP 查询的本质，是一次完整的 HTTP 请求加响应的过程，这中间涵括的 DNS 查询、建立 TCP 连接、Web 端工作等步骤，都将耗费更多时间，<code>使得建立 TLS 花费更多时长</code>。<br>而这时，OCSP Stapling 出现了。经由 OCSP Stapling（OCSP 封套），<code>Web 端将主动获取 OCSP 查询结果，并随证书一起发送给客户端</code>，以此让客户端跳过自己去寻求验证的过程，提高 TLS 握手效率。</p><h2 id="生成-OCSP-Stapling-文件"><a href="#生成-OCSP-Stapling-文件" class="headerlink" title="生成 OCSP Stapling 文件"></a>生成 OCSP Stapling 文件</h2><p>经过以下步骤生成所需的用于 OCSP Stapling 验证的文件</p><p>首先，需要准备三份证书：<br><code>站点证书</code>（website.pem）+ <code>根证书</code>（root.pem）+ <code>中间证书</code>（intermediate.pem）</p><p>中间证书和根证书，需要根据你的证书的 CA，去下载对应的证书</p><p>以下列出了 Let’s Encrypt 的中间证书和根证书的下载地址：</p><p>根证书：<br>DST Root CA X3 https://ssl-tools.net/certificates/dac9024f54d8f6df94935fb1732638ca6ad77c13.pem<br>ISRG Root X1 https://letsencrypt.org/certs/isrgrootx1.pem</p><p>中间证书：<br>Let’s Encrypt Authority X1 https://letsencrypt.org/certs/lets-encrypt-x1-cross-signed.pem<br>Let’s Encrypt Authority X2 https://letsencrypt.org/certs/lets-encrypt-x2-cross-signed.pem<br>Let’s Encrypt Authority X3 https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem<br>Let’s Encrypt Authority X4 https://letsencrypt.org/certs/lets-encrypt-x4-cross-signed.pem</p><p>这里以 DST Root CA X3 根证书 + Let’s Encrypt Authority X3 中间证书 为例（现在 Let’s Encrypt 签发的证书基本都是这样的组合）：</p><pre><code class="language-bash"># 下载根证书和中间证书
wget -O root.pem https://ssl-tools.net/certificates/dac9024f54d8f6df94935fb1732638ca6ad77c13.pem
wget -O intermediate.pem https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem

# 生成 OCSP Stapling 验证文件
# 注意，中间证书在上、根证书在下
cat cat intermediate.pem &gt; chained.pem
cat root.pem &gt;&gt; chained.pem
</code></pre><p>这样，生成的 <code>chained.pem</code> 就是所需的 OCSP Stapling 验证文件。</p><h2 id="OCSP-Stapling-Response"><a href="#OCSP-Stapling-Response" class="headerlink" title="OCSP Stapling Response"></a>OCSP Stapling Response</h2><pre><code class="language-bash">openssl x509 -in website.pem -noout -ocsp_uri
</code></pre><p>使用这个命令后，返回你的证书对应的 <code>OCSP 服务地址</code><br>例如，Let’s Encrypt 现在的 OCSP 服务地址是 http://ocsp.int-x3.letsencrypt.org/</p><p>以 Let’s Encrypt 为例，获取站点证书的 OCSP Response</p><pre><code class="language-bash">openssl ocsp -no_nonce \
    -issuer intermediate.pem \
    -CAfile chained.pem \
    -VAfile chained.pem \
    -cert website.pem \
    -url http://ocsp.int-x3.letsencrypt.org \
    -text
</code></pre><p>若没有错误，会返回如下：</p><pre><code class="language-bash">Response verify OK
website.pem: good
This Update: Oct 24 00:00:41 2017 GMT
Next Update: Oct 31 00:00:41 2017 GMT
</code></pre><h2 id="Nginx-启用-OCSP-Stapling"><a href="#Nginx-启用-OCSP-Stapling" class="headerlink" title="Nginx 启用 OCSP Stapling"></a>Nginx 启用 OCSP Stapling</h2><pre><code class="language-nginx">ssl_stapling on;
ssl_stapling_verify on;
ssl_trusted_certificate ~/chained.pem;
resolver 208.67.222.222 valid=300s;
resolver_timeout 5s;
</code></pre><p>然后重启 Nginx，就成功启用 OCSP Stapling 了</p><h2 id="OCSP-Stapling-Status"><a href="#OCSP-Stapling-Status" class="headerlink" title="OCSP Stapling Status"></a>OCSP Stapling Status</h2><pre><code class="language-bash">openssl s_client -connect sometimesnaive.org:443 -status -tlsextdebug &lt; /dev/null 2&gt;&amp;1 | grep -i &quot;OCSP response&quot;
</code></pre><p>若站点已成功启用 OCSP Stapling，会返回以下</p><pre><code class="language-bash">OCSP response:
OCSP Response Data:
    OCSP Response Status: successful (0x0)
    Response Type: Basic OCSP Response
</code></pre><p>若返回这个，明显就是失败了</p><pre><code class="language-bash">OCSP response: no response sent
</code></pre><p>也可以访问 <a href="https://www.ssllabs.com/ssltest/index.html" rel="external nofollow noopener noreferrer" target="_blank">ssllabs</a> 进行 SSL 测试，其中也能看到 OCSP Stapling 开启与否的报告。</p></section><br><div class="article-footer"><br><p>本文可能过时失效，若需更新，请留言</p><p>本博客文章均为原创，转载请注明来源</p></div><div class="nav-container"><a class="nav-right" href="/article/12.html">本博客 Nginx 配置（系列一） 安全篇 <span class="nav-arrow">→</span> </a><a class="nav-left" href="/article/14.html"><span class="nav-arrow">← </span>Hexo 搬迁记（一） 安装篇</a></div><div id="comments"></div></article><aside class="catalog-container"><div class="toc-main"><strong class="toc-title">Catalog</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#生成-OCSP-Stapling-文件"><span class="toc-nav-text">生成 OCSP Stapling 文件</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#OCSP-Stapling-Response"><span class="toc-nav-text">OCSP Stapling Response</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Nginx-启用-OCSP-Stapling"><span class="toc-nav-text">Nginx 启用 OCSP Stapling</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#OCSP-Stapling-Status"><span class="toc-nav-text">OCSP Stapling Status</span></a></li></ol></div></aside></main><script>!function(){var e="https://static.sometimesnaive.org:9004/deps/imgs/banner.jpg";$("#article-banner").css({"background-image":"url("+e+")"}),$(".header").removeClass("fixed-header")}()</script><script>(function(){
    var gitmentConfig = "nanqinlang"
    if (gitmentConfig !== 'undefined') {
        var gitment = new Gitment({
            id: "13",
            owner: "nanqinlang",
            repo: "sometimesnaive.org",
            oauth: {client_id: "b0612de512484ab34c7a", client_secret: "c2bc4cd3c947097d2ccc4c16f120d50458314dd0"},
            theme: {render(state, instance){const container = document.createElement('div');container.lang="en-US";container.className='gitment-container gitment-root-container';container.appendChild(instance.renderHeader(state, instance));container.appendChild(instance.renderEditor(state, instance));container.appendChild(instance.renderComments(state, instance));container.appendChild(instance.renderFooter(state, instance));return container;}}
        })
        gitment.render(document.getElementById('comments'))
    }
})();</script><div class="scroll-top"><span class="arrow-icon"></span></div><footer class="app-footer"><p class="copyright" align="center">&copy; 2017 - 2018 南琴浪博客 <a>(sometimesnaive.org)<a></a></a></p></footer><script src="https://static.sometimesnaive.org:9004/deps/js/function.min.js" type="application/javascript"></script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-108266909-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js" type="application/javascript"></script></body></html><!-- rebuild by neat -->