<!-- build time:Thu May 03 2018 22:55:48 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><link href="https://static.sometimesnaive.org:9004/deps/imgs/favicon.ico" type="image/x-icon" rel="icon"><title>Nginx 连接日志 access.log 的配置 | 南琴浪博客</title><link href="https://static.sometimesnaive.org:9004/deps/css/style.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/jquery.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/nprogress.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/nprogress.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/prism.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/prism.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/gitment.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/gitment.min.js" type="application/javascript"></script></head><body><header class="header fixed-header"><div class="header-container"><a class="home-link" href="/">南琴浪博客</a><ul class="right-list"><li class="list-item"><a href="/" class="item-link">Home</a></li><li class="list-item"><a href="/archive/" class="item-link">Archive</a></li><li class="list-item"><a href="/portal/atom.xml" class="item-link">RSS</a></li><li class="list-item"><a href="/portal/friendly-links" class="item-link">Links</a></li></ul><div class="menu-mask"><ul class="menu-list"><li class="menu-item"><a href="/" class="menu-link">Home</a></li><li class="menu-item"><a href="/archive/" class="menu-link">Archive</a></li><li class="menu-item"><a href="/portal/atom.xml" class="menu-link">RSS</a></li><li class="menu-item"><a href="/portal/friendly-links" class="menu-link">Links</a></li></ul></div></div></header><div id="article-banner"><h2>Nginx 连接日志 access.log 的配置</h2><p class="post-date">11/04/2017</p></div><main class="app-body flex-box"><article class="post-article"><section class="markdown-content"><p>本文讲述 Nginx 连接日志 access.log。<br><a id="more"></a></p><h2 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h2><p>真是不看不知道，一看吓一跳。作为一个平时基本不看 access.log ，甚至因此而常年 access_log off 的我，昨晚心血来潮，把 Nginx 重启时顺便打开了连接日志看看，结果一开机，就让我看见这幅惨状：</p><p><img src="https://static.sometimesnaive.org:9004/images/nginx-with-access-log/1.png" alt="一脸害怕"></p><p>我真是。。。丢你妹啊喵！这个 uptimerobot 你也真是忙啊，满屏都是你，还有这个 wp-login 都是我一年多前玩的了，现在还在抓？</p><p>所以为了干掉这俩，我写了这俩配置：</p><pre><code class="language-nginx">if ($http_user_agent ~* &quot;UptimeRobot&quot;) {
return 444;
}

deny 101.50.127.10;
deny 105.186.250.144;
</code></pre><h2 id="启用连接日志"><a href="#启用连接日志" class="headerlink" title="启用连接日志"></a>启用连接日志</h2><p>经过这一出，也让我又开始重视起了连接日志 <code>access.log</code> 这样东西，我还是决定老老实实记录日志好了：</p><pre><code class="language-nginx">access_log /home/site/access-log/access.log main;
</code></pre><p>其中的 <code>main</code> 是我给在 Nginx 全局配置中的 <code>log_format</code> 起的名字，这个名字可以随便取，如果要启用这个格式就需要在站点配置中写入对应的 <code>access_log</code> 配置。</p><h2 id="连接日志的格式"><a href="#连接日志的格式" class="headerlink" title="连接日志的格式"></a>连接日志的格式</h2><p>连接日志由<code>变量参数</code>组成，下表列出了常用的变量参数：</p><table><thead><tr><th style="text-align:left">参数</th><th style="text-align:left">定义</th></tr></thead><tbody><tr><td style="text-align:left">$remote_addr</td><td style="text-align:left">客户端地址</td></tr><tr><td style="text-align:left">$remote_user</td><td style="text-align:left">客户端用户名称</td></tr><tr><td style="text-align:left">$time_local</td><td style="text-align:left">访问时间和时区</td></tr><tr><td style="text-align:left">$http_host</td><td style="text-align:left">请求地址</td></tr><tr><td style="text-align:left">$http_referer</td><td style="text-align:left">跳转来源</td></tr><tr><td style="text-align:left">$http_user_agent</td><td style="text-align:left">客户端浏览器信息</td></tr><tr><td style="text-align:left">$status</td><td style="text-align:left">HTTP 请求状态</td></tr><tr><td style="text-align:left">$request</td><td style="text-align:left">请求的 url 和 HTTP 协议</td></tr><tr><td style="text-align:left">$request_time</td><td style="text-align:left">整个请求的总时间</td></tr><tr><td style="text-align:left">$body_bytes_sent</td><td style="text-align:left">返回给客户端的数据大小</td></tr></tbody></table><p>所以，我这样设置了我的日志格式：</p><pre><code class="language-nginx">log_format main &#39;[$time_local] [ $remote_addr $http_user_agent] [$status $request_time $request]&#39;;
</code></pre><p>我只写了一行，用中括号分为了时间、客户端信息、请求信息三部分，简洁明了。不设置过多信息同时也是为了减少负担。</p><h2 id="日志切分"><a href="#日志切分" class="headerlink" title="日志切分"></a>日志切分</h2><p>Nginx 的日志会一直写入一个固定文件中，不会自动地进行切分。时间推移，日志会越来越大，降低效率，也难以排查。所以自动切分就很有必要了。</p><p>我写了一个简易的 Bash 脚本来完成切分的任务，在 crontab 设置了定时 6 小时进行一次切分。</p><pre><code class="language-bash">logdir=/home/site/access-log
date=`date +%Y-%m-%d-%H`
pid=`cat /home/nginx/sbin/nginx.pid`

cd ${logdir}
[[ -f access.log ]] &amp;&amp; mv access.log ${date}.log &amp;&amp; kill -s USR1 ${pid}
</code></pre><p>通过将已有的 access.log 移动到 年-月-日-小时.log ，并随后通过 USR1 信号，命令 Nginx 产生新的 access.log 文件，以此来完成自动切分。</p><p>当然，你也可以 logrotates 这个强大的脚本工具，系统一般都会自带。查看其源码后，发现它也是利用了 USR1 信号。</p></section><br><div class="article-footer"><br><p>本文可能过时失效，若需更新，请留言</p><p>本博客文章均为原创，转载请注明来源</p></div><div class="nav-container"><a class="nav-right" href="/article/19.html">Nginx 启用 HTTPS 站点 <span class="nav-arrow">→</span> </a><a class="nav-left" href="/article/21.html"><span class="nav-arrow">← </span>Nginx 连接日志的封禁 IP 脚本</a></div><div id="comments"></div></article><aside class="catalog-container"><div class="toc-main"><strong class="toc-title">Catalog</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#引子"><span class="toc-nav-text">引子</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#启用连接日志"><span class="toc-nav-text">启用连接日志</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#连接日志的格式"><span class="toc-nav-text">连接日志的格式</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#日志切分"><span class="toc-nav-text">日志切分</span></a></li></ol></div></aside></main><script>!function(){var e="https://static.sometimesnaive.org:9004/deps/imgs/banner.jpg";$("#article-banner").css({"background-image":"url("+e+")"}),$(".header").removeClass("fixed-header")}()</script><script>(function(){
    var gitmentConfig = "nanqinlang"
    if (gitmentConfig !== 'undefined') {
        var gitment = new Gitment({
            id: "20",
            owner: "nanqinlang",
            repo: "sometimesnaive.org",
            oauth: {client_id: "b0612de512484ab34c7a", client_secret: "c2bc4cd3c947097d2ccc4c16f120d50458314dd0"},
            theme: {render(state, instance){const container = document.createElement('div');container.lang="en-US";container.className='gitment-container gitment-root-container';container.appendChild(instance.renderHeader(state, instance));container.appendChild(instance.renderEditor(state, instance));container.appendChild(instance.renderComments(state, instance));container.appendChild(instance.renderFooter(state, instance));return container;}}
        })
        gitment.render(document.getElementById('comments'))
    }
})();</script><div class="scroll-top"><span class="arrow-icon"></span></div><footer class="app-footer"><p class="copyright" align="center">&copy; 2017 - 2018 南琴浪博客 <a>(sometimesnaive.org)<a></a></a></p></footer><script src="https://static.sometimesnaive.org:9004/deps/js/function.min.js" type="application/javascript"></script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-108266909-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js" type="application/javascript"></script></body></html><!-- rebuild by neat -->