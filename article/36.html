<!-- build time:Thu May 03 2018 22:55:47 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><link href="https://static.sometimesnaive.org:9004/deps/imgs/favicon.ico" type="image/x-icon" rel="icon"><title>Nginx 启用 proxy_cache 缓存 | 南琴浪博客</title><link href="https://static.sometimesnaive.org:9004/deps/css/style.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/jquery.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/nprogress.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/nprogress.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/prism.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/prism.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/gitment.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/gitment.min.js" type="application/javascript"></script></head><body><header class="header fixed-header"><div class="header-container"><a class="home-link" href="/">南琴浪博客</a><ul class="right-list"><li class="list-item"><a href="/" class="item-link">Home</a></li><li class="list-item"><a href="/archive/" class="item-link">Archive</a></li><li class="list-item"><a href="/portal/atom.xml" class="item-link">RSS</a></li><li class="list-item"><a href="/portal/friendly-links" class="item-link">Links</a></li></ul><div class="menu-mask"><ul class="menu-list"><li class="menu-item"><a href="/" class="menu-link">Home</a></li><li class="menu-item"><a href="/archive/" class="menu-link">Archive</a></li><li class="menu-item"><a href="/portal/atom.xml" class="menu-link">RSS</a></li><li class="menu-item"><a href="/portal/friendly-links" class="menu-link">Links</a></li></ul></div></div></header><div id="article-banner"><h2>Nginx 启用 proxy_cache 缓存</h2><p class="post-date">12/22/2017</p></div><main class="app-body flex-box"><article class="post-article"><section class="markdown-content"><p>顾名思义，<code>proxy_cache</code> 是用于 proxy 模式（一般也可称为反代）的缓存功能。本文介绍其基本用法。<br><a id="more"></a></p><p>proxy_cache 在 Nginx 配置的 http 段、server 段（location 段）中分别写入不同的配置。<code>http</code> 段中的配置用于定义 proxy_cache 空间，<code>server</code> 段中的配置用于调用 http 段中的定义，启用对 server 的缓存功能。</p><h2 id="http-段"><a href="#http-段" class="headerlink" title="http 段"></a>http 段</h2><p>直接以本站的配置为例：</p><pre><code class="language-nginx">proxy_cache_path    /home/nginx/proxy_cache/cache levels=1:2 keys_zone=proxycache:60m max_size=120m inactive=2h use_temp_path=on;
proxy_temp_path        /home/nginx/proxy_cache/temp;
proxy_cache_key        $host$request_uri;
</code></pre><p>其中：</p><ul><li>proxy_cache_path<ul><li><code>/home/nginx/proxy_cache/cache</code>：定义 proxy_cache 生成文件的根路径</li><li><code>levels</code>：默认所有缓存文件都放在上面指定的根路径中，从而可能影响缓存的性能。推荐指定为 2 级目录来存储缓存文件</li><li><code>key_zone</code>：这个的值是字符串，可以随意写。用于在共享内存中定义一块存储区域来存放缓存的 key 和 metadata（类似于使用次数），这样 nginx 可以快速判断一个 request 是否命中缓存。1m 可以存储 8000 个key</li><li><code>max_size</code>：最大 cache 空间。如果不指定，会使用掉所有 disk space。当达到 disk 上限后，会删除最少使用的 cache</li><li><code>inactive</code>：内存中缓存的过期检查周期。示例配置中如果 2h 内都没有被访问，则不论状态是否为 expired，都会清除缓存。需要注意的是，inactive 和 expired 配置项的含义是不同的，expired 只是判断过期时间，不会删除缓存；而 inactive 是直接删除过期缓存</li><li><code>use_temp_path</code>：如果为 off，则 nginx 会将缓存文件直接写入指定的 cache 文件中，而不使用 temp_path 指定的临时存储路径</li></ul></li><li>proxy_temp_path<ul><li><code>/home/nginx/proxy_cache/temp</code>：定义 proxy_cache 生成临时文件的根路径。此项在 use_temp_path=off 时不需填写</li></ul></li><li>proxy_cache_key<ul><li><code>$host$request_uri</code>：定义 proxy_cache 生成文件的名称。值可以为 Nginx 支持的变量和字符串</li></ul></li></ul><h2 id="server-段"><a href="#server-段" class="headerlink" title="server 段"></a>server 段</h2><p>同样以本站配置为例进行说明：</p><pre><code class="language-nginx">proxy_cache                    proxycache;
proxy_cache_valid            304 2h;
proxy_cache_valid            403 444 24h;
proxy_cache_valid            404 2h;
proxy_cache_valid            500 502 2h;
proxy_cache_use_stale        invalid_header http_403 http_404 http_500 http_502;
proxy_cache_lock            on;
proxy_cache_lock_timeout    5s;
proxy_no_cache                $proxynocache_atomxml $proxynocache_sitemapxml;
</code></pre><ul><li><code>proxy_cache</code>：对应 http 段的 <code>key_zone</code>，是你定义的 proxy_cache 所使用的共享空间的名称。我在上面示例中使用的名称是“proxycache”</li><li><code>proxy_cache_valid</code>：对指定的 HTTP 状态进行缓存，并指定缓存时间。可以自定义写入多个配置项</li><li><code>proxy_cache_stale</code>：这个可以大大减少回源次数。因此可以将 inactive 适当延长</li><li><code>proxy_cache_lock</code>：同样是减少回源次数。和上面的差别在于缓存是否存在</li><li><code>proxy_no_cache</code>：值为若干个变量($string)，这个变量的值只有俩类，<code>0 和 非0</code>，这若干个变量中只要有一个值不为 0，就不会触发缓存</li></ul><h2 id="我的一点经验"><a href="#我的一点经验" class="headerlink" title="我的一点经验"></a>我的一点经验</h2><ul><li>会在你指定的缓存路径下生成类似 “0 1 2 3 4 5 6 7 8 9 a b c d e f …” 这样的文件夹（当 levels=2 时），这些文件夹下存储着写入硬盘的缓存文件</li><li>proxy_cache_valid 缓存的状态码需要根据你的需要来定义，千万别把 200 写进去了</li><li>inactive 时间和 valid 时间需要特别注意，如果源站更新频率不怎么低，就需要根据你的需求减少这些值</li><li>proxy_no_cache 中使用的 $string 是通过类似 “set $string 1;” 来定义的</li><li>proxy_cache_use_stale 和 proxy_cache_lock 的用法目前我也没太明白，所以解释得不太清晰，望见谅。这俩配置一般不使用也无妨</li></ul></section><br><div class="article-footer"><br><p>本文可能过时失效，若需更新，请留言</p><p>本博客文章均为原创，转载请注明来源</p></div><div class="nav-container"><a class="nav-right" href="/article/35.html">Hexo 搬迁记（二） 插件篇 <span class="nav-arrow">→</span> </a><a class="nav-left" href="/article/37.html"><span class="nav-arrow">← </span>魔改 BBR 一键脚本 for Debian &amp; CentOS</a></div><div id="comments"></div></article><aside class="catalog-container"><div class="toc-main"><strong class="toc-title">Catalog</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#http-段"><span class="toc-nav-text">http 段</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#server-段"><span class="toc-nav-text">server 段</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#我的一点经验"><span class="toc-nav-text">我的一点经验</span></a></li></ol></div></aside></main><script>!function(){var e="https://static.sometimesnaive.org:9004/deps/imgs/banner.jpg";$("#article-banner").css({"background-image":"url("+e+")"}),$(".header").removeClass("fixed-header")}()</script><script>(function(){
    var gitmentConfig = "nanqinlang"
    if (gitmentConfig !== 'undefined') {
        var gitment = new Gitment({
            id: "36",
            owner: "nanqinlang",
            repo: "sometimesnaive.org",
            oauth: {client_id: "b0612de512484ab34c7a", client_secret: "c2bc4cd3c947097d2ccc4c16f120d50458314dd0"},
            theme: {render(state, instance){const container = document.createElement('div');container.lang="en-US";container.className='gitment-container gitment-root-container';container.appendChild(instance.renderHeader(state, instance));container.appendChild(instance.renderEditor(state, instance));container.appendChild(instance.renderComments(state, instance));container.appendChild(instance.renderFooter(state, instance));return container;}}
        })
        gitment.render(document.getElementById('comments'))
    }
})();</script><div class="scroll-top"><span class="arrow-icon"></span></div><footer class="app-footer"><p class="copyright" align="center">&copy; 2017 - 2018 南琴浪博客 <a>(sometimesnaive.org)<a></a></a></p></footer><script src="https://static.sometimesnaive.org:9004/deps/js/function.min.js" type="application/javascript"></script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-108266909-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js" type="application/javascript"></script></body></html><!-- rebuild by neat -->