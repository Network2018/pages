<!-- build time:Thu May 03 2018 22:55:47 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><link href="https://static.sometimesnaive.org:9004/deps/imgs/favicon.ico" type="image/x-icon" rel="icon"><title>Nginx 启用 proxy_buffer 缓冲 | 南琴浪博客</title><link href="https://static.sometimesnaive.org:9004/deps/css/style.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/jquery.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/nprogress.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/nprogress.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/prism.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/prism.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/gitment.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/gitment.min.js" type="application/javascript"></script></head><body><header class="header fixed-header"><div class="header-container"><a class="home-link" href="/">南琴浪博客</a><ul class="right-list"><li class="list-item"><a href="/" class="item-link">Home</a></li><li class="list-item"><a href="/archive/" class="item-link">Archive</a></li><li class="list-item"><a href="/portal/atom.xml" class="item-link">RSS</a></li><li class="list-item"><a href="/portal/friendly-links" class="item-link">Links</a></li></ul><div class="menu-mask"><ul class="menu-list"><li class="menu-item"><a href="/" class="menu-link">Home</a></li><li class="menu-item"><a href="/archive/" class="menu-link">Archive</a></li><li class="menu-item"><a href="/portal/atom.xml" class="menu-link">RSS</a></li><li class="menu-item"><a href="/portal/friendly-links" class="menu-link">Links</a></li></ul></div></div></header><div id="article-banner"><h2>Nginx 启用 proxy_buffer 缓冲</h2><p class="post-date">01/01/2018</p></div><main class="app-body flex-box"><article class="post-article"><section class="markdown-content"><p>顾名思义，proxy_buffer 是用于 proxy 模式的缓冲功能。本文介绍其基本用法。<br><a id="more"></a></p><h2 id="buffer-是什么"><a href="#buffer-是什么" class="headerlink" title="buffer 是什么"></a>buffer 是什么</h2><p><code>buffer</code>，即缓冲区，它在 Nginx 上发挥的作用就是<code>启用一个缓冲区，先在这个缓冲区内进行存储，再把数据发送出去</code>。和在线观看视频有点类似，先把视频文件缓冲一部分到本地再开始播放。</p><p>若没有 buffer，数据将会直接从 Nginx 传输到客户端。假设如果客户端的加载速度足够快，你可以直接把 buffer 关掉，让数据尽可能快地到达客户端。</p><p>而使用 buffer，Nginx 将会临时存储后端 response 到缓冲区，然后慢慢把数据发送到客户端。启用 buffer 的好处在于可以把数据一次性地发送给目标，相较于即时传输可以节约出这部分带宽。</p><p>顺带一提，Nginx 全局配置中的 <code>tcp_nopush</code> 的作用就是<code>数据包会累计到一定大小之后才会发送</code>。而 <code>tcp_nodelay</code> 是尽快发送数据，所以若你启用了 buffer，建议关闭 tcp_nodelay。</p><h2 id="proxy-buffer-的配置"><a href="#proxy-buffer-的配置" class="headerlink" title="proxy_buffer 的配置"></a>proxy_buffer 的配置</h2><p><code>proxy_buffer</code> 是用于 proxy 模式（一般也可称为反向代理）的 buffer 配置。Nginx 有另外一种适用于 server 模式的 buffer 配置，这里本帖不做介绍。</p><p>proxy_buffer 包括了以下配置项：</p><p>需注意，以下指定的数值都是针对每一个 http request 的上限，而不是对于整个 buffer 区指定的上限。</p><h3 id="proxy-buffering"><a href="#proxy-buffering" class="headerlink" title="proxy_buffering"></a>proxy_buffering</h3><pre><code class="language-nginx">proxy_buffering  on;
</code></pre><p>在 <code>proxy_buffering</code> 开启的时候，proxy_buffers 和 proxy_busy_buffers_size 才会起作用。</p><h3 id="proxy-buffers"><a href="#proxy-buffers" class="headerlink" title="proxy_buffers"></a>proxy_buffers</h3><pre><code class="language-nginx">proxy_buffers  4 8k;
</code></pre><p>指定一个 request 的 buffer 的数量和大小。</p><h3 id="proxy-buffer-size"><a href="#proxy-buffer-size" class="headerlink" title="proxy_buffer_size"></a>proxy_buffer_size</h3><pre><code class="language-nginx">proxy_buffer_size  4k;
</code></pre><p>指定后端 response 的 buffer 的大小。它是来自后端 response 的一部分，它包含 Headers，从 response 分离出来。它仅用于限定 headers 的 buffer 区，所以它的值比 proxy_buffers 更低。</p><p>proxy_buffer_size 有一点特殊在于，无论 proxy_buffering 是否开启，proxy_buffer_size 都会起作用。</p><h3 id="proxy-busy-buffers-size"><a href="#proxy-busy-buffers-size" class="headerlink" title="proxy_busy_buffers_size"></a>proxy_busy_buffers_size</h3><pre><code class="language-nginx">proxy_busy_buffers_size  12k;
</code></pre><p>忙时 buffer 的最大值。一个客户端一次只能从一个 buffer 中读取数据的同时，剩下的 buffer 会被放到队列中，等待发送到客户端，这个 directive 指定在这个状态下的 buffer 的大小。</p></section><br><div class="article-footer"><br><p>本文可能过时失效，若需更新，请留言</p><p>本博客文章均为原创，转载请注明来源</p></div><div class="nav-container"><a class="nav-right" href="/article/43.html">Nginx 基础教程（一）建立一个网站 <span class="nav-arrow">→</span> </a><a class="nav-left" href="/article/45.html"><span class="nav-arrow">← </span>年终总结 2017</a></div><div id="comments"></div></article><aside class="catalog-container"><div class="toc-main"><strong class="toc-title">Catalog</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#buffer-是什么"><span class="toc-nav-text">buffer 是什么</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#proxy-buffer-的配置"><span class="toc-nav-text">proxy_buffer 的配置</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#proxy-buffering"><span class="toc-nav-text">proxy_buffering</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#proxy-buffers"><span class="toc-nav-text">proxy_buffers</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#proxy-buffer-size"><span class="toc-nav-text">proxy_buffer_size</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#proxy-busy-buffers-size"><span class="toc-nav-text">proxy_busy_buffers_size</span></a></li></ol></li></ol></div></aside></main><script>!function(){var e="https://static.sometimesnaive.org:9004/deps/imgs/banner.jpg";$("#article-banner").css({"background-image":"url("+e+")"}),$(".header").removeClass("fixed-header")}()</script><script>(function(){
    var gitmentConfig = "nanqinlang"
    if (gitmentConfig !== 'undefined') {
        var gitment = new Gitment({
            id: "44",
            owner: "nanqinlang",
            repo: "sometimesnaive.org",
            oauth: {client_id: "b0612de512484ab34c7a", client_secret: "c2bc4cd3c947097d2ccc4c16f120d50458314dd0"},
            theme: {render(state, instance){const container = document.createElement('div');container.lang="en-US";container.className='gitment-container gitment-root-container';container.appendChild(instance.renderHeader(state, instance));container.appendChild(instance.renderEditor(state, instance));container.appendChild(instance.renderComments(state, instance));container.appendChild(instance.renderFooter(state, instance));return container;}}
        })
        gitment.render(document.getElementById('comments'))
    }
})();</script><div class="scroll-top"><span class="arrow-icon"></span></div><footer class="app-footer"><p class="copyright" align="center">&copy; 2017 - 2018 南琴浪博客 <a>(sometimesnaive.org)<a></a></a></p></footer><script src="https://static.sometimesnaive.org:9004/deps/js/function.min.js" type="application/javascript"></script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-108266909-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js" type="application/javascript"></script></body></html><!-- rebuild by neat -->