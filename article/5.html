<!-- build time:Sat May 05 2018 01:46:54 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><link href="https://static.sometimesnaive.org:9004/deps/imgs/favicon.ico" type="image/x-icon" rel="icon"><title>使用 CloudFlare 实现 DDNS (动态域名解析) | 南琴浪博客</title><link href="https://static.sometimesnaive.org:9004/deps/css/style.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/jquery.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/nprogress.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/nprogress.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/prism.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/prism.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/gitment.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/gitment.min.js" type="application/javascript"></script></head><body><header class="header fixed-header"><div class="header-container"><a class="home-link" href="/">南琴浪博客</a><ul class="right-list"><li class="list-item"><a href="/" class="item-link">Home</a></li><li class="list-item"><a href="/archive/" class="item-link">Archive</a></li><li class="list-item"><a href="/portal/atom.xml" class="item-link">RSS</a></li><li class="list-item"><a href="/portal/friendly-links" class="item-link">Links</a></li></ul><div class="menu-mask"><ul class="menu-list"><li class="menu-item"><a href="/" class="menu-link">Home</a></li><li class="menu-item"><a href="/archive/" class="menu-link">Archive</a></li><li class="menu-item"><a href="/portal/atom.xml" class="menu-link">RSS</a></li><li class="menu-item"><a href="/portal/friendly-links" class="menu-link">Links</a></li></ul></div></div></header><div id="article-banner"><h2>使用 CloudFlare 实现 DDNS (动态域名解析)</h2><p class="post-date">09/28/2017</p></div><main class="app-body flex-box"><article class="post-article"><section class="markdown-content"><p>动态 DNS（英语：Dynamic DNS，简称 DDNS）是域名系统（DNS）中的一种自动更新名称服务器（Name server）内容的技术。根据互联网的域名订立规则，域名必须跟从固定的IP地址。但动态DNS系统为动态网域提供一个固定的名称服务器（Name server），通过即时更新，使外界用户能够连上动态用户的网址。摘自 <a href="https://zh.wikipedia.org/wiki/動態DNS" rel="external nofollow noopener noreferrer" target="_blank">维基百科-动态DNS</a><br><a id="more"></a></p><p>当你需要使用你的域名指向一个动态 ip 时，就需要有一个支持动态 dns 的域名托管商。<br>CloudFlare 是非常有名的域名托管商和 CDN 提供商，提供高质量的免费服务，拥有国内外大量用户。本文就将讲解如何使用 CloudFlare 实现 DDNS (动态域名解析)</p><h2 id="开始操作"><a href="#开始操作" class="headerlink" title="开始操作"></a>开始操作</h2><p>CloudFlare 提供有非常强大的 API ，具体可以参看 <a href="https://api.cloudflare.com/#zone-properties" rel="external nofollow noopener noreferrer" target="_blank">Cloudflare API documentation v4</a><br>为了实现 DDNS ，需要使 <code>A记录指向的 ip 的能够动态变化</code>，我们这里利用 API 进行定时操作</p><h3 id="获取帐号信息"><a href="#获取帐号信息" class="headerlink" title="获取帐号信息"></a>获取帐号信息</h3><p>首先要 <code>获取你的 CloudFlare 帐号的相关信息</code> ：</p><p>1.邮箱<br>就是你的 CloudFlare 帐号的邮箱<br>进入 “https://www.cloudflare.com/a/profile“ 就能看到<br><img src="https://static.sometimesnaive.org:9004/images/cloudflare-ddns-api/email.png" alt="这是你的 CloudFlare 帐号的邮箱"></p><p>2.zone_id<br>这个位于 “https://www.cloudflare.com/a/overview“ 的第二块区域 “Domain Summary” 的右侧<br><img src="https://static.sometimesnaive.org:9004/images/cloudflare-ddns-api/zone_id.png" alt="下滑到第二块区域 &quot;Domain Summary&quot; 的右侧就能看到"></p><p>3.api_key<br>找到 zone_id 后，点击 “Get your API key” ，往下滑动到第四块区域 “API Key” ，点击第一行 “Global API Key” 后面的 “View API Key”<br><img src="https://static.sometimesnaive.org:9004/images/cloudflare-ddns-api/api_key_menu.png" alt="找到这个菜单"><br><img src="https://static.sometimesnaive.org:9004/images/cloudflare-ddns-api/api_key.png" alt="这就是你的 api_key"></p><h3 id="创建-DNS-Record"><a href="#创建-DNS-Record" class="headerlink" title="创建 DNS Record"></a>创建 DNS Record</h3><p>example：</p><pre><code class="language-bash">root@nanqinlang:~ 
#执行
    curl -X POST &quot;https://api.cloudflare.com/client/v4/zones/8ee1be75cxxxx(我的zone_id)/dns_records&quot; \
    -H &quot;X-Auth-Email: xxxx(我的帐号的邮箱)&quot; \
    -H &quot;X-Auth-Key: 8405868bdxxxx(我的api_key)&quot; \
    -H &quot;Content-Type: application/json&quot; \
    --data &#39;{&quot;type&quot;:&quot;A&quot;,&quot;name&quot;:&quot;test.nanqinlang.com（指定要创建记录的域名）&quot;,&quot;content&quot;:&quot;127.0.0.1(指定A记录指向的ip)&quot;,&quot;ttl&quot;:120（指定ttl）,&quot;proxied&quot;:false}&#39;
#返回结果
{&quot;result&quot;:{&quot;id&quot;:&quot;3abbbaba2xxxx(这条创建的dns记录的id)&quot;,&quot;type&quot;:&quot;A&quot;,&quot;name&quot;:&quot;test.nanqinlang.com（创建记录的域名）&quot;,&quot;content&quot;:&quot;127.0.0.1(A记录指向的ip)&quot;,&quot;proxiable&quot;:false,&quot;proxied&quot;:false,&quot;ttl&quot;:120,&quot;locked&quot;:false,&quot;zone_id&quot;:&quot;8ee1be75cxxxx(我的zone_id)&quot;,&quot;zone_name&quot;:&quot;nanqinlang.com&quot;,&quot;modified_on&quot;:&quot;2017-09-27T16:38:18.430924Z&quot;,&quot;created_on&quot;:&quot;2017-09-27T16:38:18.430924Z&quot;,&quot;meta&quot;:{&quot;auto_added&quot;:false}},&quot;success&quot;:true（命令执行成功）,&quot;errors&quot;:[],&quot;messages&quot;:[]}
</code></pre><p>执行成功后，创建的记录如图<br><img src="https://static.sometimesnaive.org:9004/images/cloudflare-ddns-api/record.png" alt="记录创建成功后，就能在 DNS Records 中看到了"></p><h3 id="查看-DNS-Record-列表"><a href="#查看-DNS-Record-列表" class="headerlink" title="查看 DNS Record 列表"></a>查看 DNS Record 列表</h3><p>执行下面这个命令后，shell 窗口中会列出你的帐号上的所有 dns 记录（不仅仅是A记录）<br>在 cloudflare ，每一条解析记录都有对应的一个固定的 id<br>为了能够通过 API 修改解析记录，我们需要通过此步骤来获取这个 id<br>example：</p><pre><code class="language-bash">root@nanqinlang:~ 
#执行
    curl -X GET &quot;https://api.cloudflare.com/client/v4/zones/8ee1be75cxxxx(我的zone_id)/dns_records&quot; \
    -H &quot;X-Auth-Email: xxxx(我的帐号的邮箱)&quot; \
    -H &quot;X-Auth-Key: 8405868bdxxxx(我的api_key)&quot; \
    -H &quot;Content-Type: application/json&quot;
#返回结果
{&quot;result&quot;:[{&quot;id&quot;:&quot;3625aca17xxxx(这条被查看的dns记录的id)&quot;,&quot;type&quot;:&quot;A&quot;,&quot;name&quot;:&quot;nanqinlang.com（域名）&quot;,&quot;content&quot;:&quot;xx.xx.xx.xx(A记录指向的ip)&quot;,&quot;proxiable&quot;:true,&quot;proxied&quot;:true（启用cloudflare反代与否的状态值）,&quot;ttl&quot;:1（1 表示 auto ttl）,&quot;locked&quot;:false,&quot;zone_id&quot;:&quot;8ee1be75cxxxx(我的zone_id)&quot;,&quot;zone_name&quot;:&quot;nanqinlang.com（根域名）&quot;,&quot;modified_on&quot;:&quot;2017-09-26T15:24:00.567936Z&quot;,&quot;created_on&quot;:&quot;2017-09-26T15:24:00.567936Z&quot;,&quot;meta&quot;:{&quot;auto_added&quot;:false}}}
</code></pre><p>其中的 <code>&quot;id&quot;:&quot;3625aca17xxxx&quot;</code> 就是你需要的 dns 记录的 id</p><h3 id="更新-DNS-Record"><a href="#更新-DNS-Record" class="headerlink" title="更新 DNS Record"></a>更新 DNS Record</h3><p>当创建好解析记录，并获取了这条记录的 id 之后，<br>为了实现动态解析，每当你的公网 ip 发生变化，就需要更新 dns 记录，将A记录指向你的新 ip<br>example：</p><pre><code class="language-bash">root@nanqinlang:~ 
#执行
    curl -X PUT &quot;https://api.cloudflare.com/client/v4/zones/8ee1be75cxxxx(我的zone_id)/dns_records/3abbbaba2xxxx(这条dns记录的id)&quot; \
    -H &quot;X-Auth-Email: xxxx(我的帐号的邮箱)&quot; \
    -H &quot;X-Auth-Key: 8405868bdxxxx(我的api_key)&quot; \
    -H &quot;Content-Type: application/json&quot; \
    --data &#39;{&quot;type&quot;:&quot;A&quot;,&quot;name&quot;:&quot;test.nanqinlang.com（指定要更新记录的域名）&quot;,&quot;content&quot;:&quot;110.119.120.233(指定A记录指向的ip)&quot;,&quot;ttl&quot;:180（指定ttl）,&quot;proxied&quot;:false}&#39;
#返回结果
{&quot;result&quot;:{&quot;id&quot;:&quot;3abbbaba2xxxx(这条要更新的dns记录的id)&quot;,&quot;type&quot;:&quot;A&quot;,&quot;name&quot;:&quot;test.nanqinlang.com（更新了记录的域名）&quot;,&quot;content&quot;:&quot;110.119.120.233（更新后的指向ip）&quot;,&quot;proxiable&quot;:true,&quot;proxied&quot;:false,&quot;ttl&quot;:180（更新后的ttl）,&quot;locked&quot;:false,&quot;zone_id&quot;:&quot;8ee1be75cccxxxx(我的zone_id)&quot;,&quot;zone_name&quot;:&quot;nanqinlang.com&quot;,&quot;modified_on&quot;:&quot;2017-09-27T16:58:23.547640Z&quot;,&quot;created_on&quot;:&quot;2017-09-27T16:58:23.547640Z&quot;,&quot;meta&quot;:{&quot;auto_added&quot;:false}},&quot;success&quot;:true（命令执行成功）,&quot;errors&quot;:[],&quot;messages&quot;:[]}
</code></pre><p>将此命令进行定时任务后，就实现了 DDNS 域名动态解析 了。</p><h2 id="我的脚本"><a href="#我的脚本" class="headerlink" title="我的脚本"></a>我的脚本</h2><p>https://github.com/nanqinlang-script/CloudFlare_DNSRecord_Modifier<br>写了一个脚本用于实现此目的，配合定时任务食用即可<br>请注意，本文所讲的方法并不仅仅能用于 DDNS 的配置，<br>也能单纯的用于对某条 dns 记录的单一次的创建和修改</p></section><br><div class="article-footer"><br><p>本文可能过时失效，若需更新，请留言</p><p>本博客文章均为原创，转载请注明来源</p></div><div class="nav-container"><a class="nav-right" href="/article/4.html">dnsmasq - 自建 DNS 服务 <span class="nav-arrow">→</span> </a><a class="nav-left" href="/article/6.html"><span class="nav-arrow">← </span>回程路由测试脚本 - testrace</a></div><div id="comments"></div></article><aside class="catalog-container"><div class="toc-main"><strong class="toc-title">Catalog</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#开始操作"><span class="toc-nav-text">开始操作</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#获取帐号信息"><span class="toc-nav-text">获取帐号信息</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#创建-DNS-Record"><span class="toc-nav-text">创建 DNS Record</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#查看-DNS-Record-列表"><span class="toc-nav-text">查看 DNS Record 列表</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#更新-DNS-Record"><span class="toc-nav-text">更新 DNS Record</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#我的脚本"><span class="toc-nav-text">我的脚本</span></a></li></ol></div></aside></main><script>!function(){var e="https://static.sometimesnaive.org:9004/deps/imgs/banner.jpg";$("#article-banner").css({"background-image":"url("+e+")"}),$(".header").removeClass("fixed-header")}()</script><script>(function(){
    var gitmentConfig = "nanqinlang"
    if (gitmentConfig !== 'undefined') {
        var gitment = new Gitment({
            id: "5",
            owner: "nanqinlang",
            repo: "sometimesnaive.org",
            oauth: {client_id: "b0612de512484ab34c7a", client_secret: "c2bc4cd3c947097d2ccc4c16f120d50458314dd0"},
            theme: {render(state, instance){const container = document.createElement('div');container.lang="en-US";container.className='gitment-container gitment-root-container';container.appendChild(instance.renderHeader(state, instance));container.appendChild(instance.renderEditor(state, instance));container.appendChild(instance.renderComments(state, instance));container.appendChild(instance.renderFooter(state, instance));return container;}}
        })
        gitment.render(document.getElementById('comments'))
    }
})();</script><div class="scroll-top"><span class="arrow-icon"></span></div><footer class="app-footer"><p class="copyright" align="center">&copy; 2017 - 2018 南琴浪博客 <a>(sometimesnaive.org)<a></a></a></p></footer><script src="https://static.sometimesnaive.org:9004/deps/js/function.min.js" type="application/javascript"></script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-108266909-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js" type="application/javascript"></script></body></html><!-- rebuild by neat -->