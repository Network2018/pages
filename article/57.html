<!-- build time:Thu May 03 2018 22:55:47 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><link href="https://static.sometimesnaive.org:9004/deps/imgs/favicon.ico" type="image/x-icon" rel="icon"><title>Nginx 配置 HTTP 跳转 HTTPS | 南琴浪博客</title><link href="https://static.sometimesnaive.org:9004/deps/css/style.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/jquery.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/nprogress.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/nprogress.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/prism.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/prism.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/gitment.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/gitment.min.js" type="application/javascript"></script></head><body><header class="header fixed-header"><div class="header-container"><a class="home-link" href="/">南琴浪博客</a><ul class="right-list"><li class="list-item"><a href="/" class="item-link">Home</a></li><li class="list-item"><a href="/archive/" class="item-link">Archive</a></li><li class="list-item"><a href="/portal/atom.xml" class="item-link">RSS</a></li><li class="list-item"><a href="/portal/friendly-links" class="item-link">Links</a></li></ul><div class="menu-mask"><ul class="menu-list"><li class="menu-item"><a href="/" class="menu-link">Home</a></li><li class="menu-item"><a href="/archive/" class="menu-link">Archive</a></li><li class="menu-item"><a href="/portal/atom.xml" class="menu-link">RSS</a></li><li class="menu-item"><a href="/portal/friendly-links" class="menu-link">Links</a></li></ul></div></div></header><div id="article-banner"><h2>Nginx 配置 HTTP 跳转 HTTPS</h2><p class="post-date">02/23/2018</p></div><main class="app-body flex-box"><article class="post-article"><section class="markdown-content"><p>本文介绍 Nginx 访问 HTTP 跳转 HTTPS 的 4 种配置方式。<br><a id="more"></a></p><h2 id="rewrite"><a href="#rewrite" class="headerlink" title="rewrite"></a>rewrite</h2><p>Nginx rewrite 有四种 flag：</p><ul><li>break：在一个请求处理过程中将原来的 url 改写之后，再继续进行后面的处理，这个重写之后的请求始终都是在当前这一个 location 中处理</li><li>last：相当于一个新的 request，需要重新走一遍 server，提供了一个可以转到其他 location 的机会</li><li>redirect：表示 302 temporarily redirect</li><li>permanent：表示 301 permanently redirect</li></ul><p>要使用 HTTP 跳转 HTTPS，当然是需要 301 跳转，即使用 permanent 这个标签：</p><pre><code class="language-nginx">    rewrite  ^(.*)  https://$server_name$1 permanent;
</code></pre><p>提醒：以上配置涉及到三个本文并未提及的点：rewrite 用法、全局变量、正则匹配。</p><h2 id="301-状态码"><a href="#301-状态码" class="headerlink" title="301 状态码"></a>301 状态码</h2><p>Nginx 使用 <code>ruturn ${http_code}</code> 指定对应状态码的处理。这里我们使用 return 301 指定 301 重定向的目标：</p><pre><code class="language-nginx">    return  301  https://$server_name$request_uri;
</code></pre><h2 id="497-状态码"><a href="#497-状态码" class="headerlink" title="497 状态码"></a>497 状态码</h2><p>当 server 只允许 HTTPS 请求时，基于 HTTP 的访问会被 Nginx 返回 497 错误。这时我们使用 error_page 将访问重定向至 HTTPS 上：</p><pre><code class="language-nginx">    error_page  497  https://$server_name$request_uri;
</code></pre><h2 id="meta"><a href="#meta" class="headerlink" title="meta"></a>meta</h2><p>还有一种方式是，返回一个<code>写入 meta 标签</code>的 html 页面，让浏览器跳转。和上面三种方式不同，此方案不在 Nginx 上进行跳转，节约服务器资源，而缺点是不能写入 $request_uri 变量，只能跳转到固定地址。</p><pre><code class="language-nginx">server {
    ...

    index  meta.html;
    error_page 404 meta.html;
}
</code></pre><p>在要返回的 meta.html 中写入：</p><pre><code class="language-html">&lt;html&gt;
  &lt;meta http-equiv=&quot;refresh&quot; content=&quot;0; url=${你要跳转的目标地址}&quot;&gt;
&lt;/html&gt;
</code></pre><p>本站就使用这个方案，所以我是这样写的：</p><pre><code class="language-html">&lt;html&gt;
  &lt;meta http-equiv=&quot;refresh&quot; content=&quot;0; url=https://sometimesnaive.org/&quot;&gt;
&lt;/html&gt;
</code></pre></section><br><div class="article-footer"><br><p>本文可能过时失效，若需更新，请留言</p><p>本博客文章均为原创，转载请注明来源</p></div><div class="nav-container"><a class="nav-right" href="/article/56.html">Nginx 启用 HTTP/2 <span class="nav-arrow">→</span> </a><a class="nav-left" href="/article/58.html"><span class="nav-arrow">← </span>本博客 Nginx 配置（第二季）</a></div><div id="comments"></div></article><aside class="catalog-container"><div class="toc-main"><strong class="toc-title">Catalog</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#rewrite"><span class="toc-nav-text">rewrite</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#301-状态码"><span class="toc-nav-text">301 状态码</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#497-状态码"><span class="toc-nav-text">497 状态码</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#meta"><span class="toc-nav-text">meta</span></a></li></ol></div></aside></main><script>!function(){var e="https://static.sometimesnaive.org:9004/deps/imgs/banner.jpg";$("#article-banner").css({"background-image":"url("+e+")"}),$(".header").removeClass("fixed-header")}()</script><script>(function(){
    var gitmentConfig = "nanqinlang"
    if (gitmentConfig !== 'undefined') {
        var gitment = new Gitment({
            id: "57",
            owner: "nanqinlang",
            repo: "sometimesnaive.org",
            oauth: {client_id: "b0612de512484ab34c7a", client_secret: "c2bc4cd3c947097d2ccc4c16f120d50458314dd0"},
            theme: {render(state, instance){const container = document.createElement('div');container.lang="en-US";container.className='gitment-container gitment-root-container';container.appendChild(instance.renderHeader(state, instance));container.appendChild(instance.renderEditor(state, instance));container.appendChild(instance.renderComments(state, instance));container.appendChild(instance.renderFooter(state, instance));return container;}}
        })
        gitment.render(document.getElementById('comments'))
    }
})();</script><div class="scroll-top"><span class="arrow-icon"></span></div><footer class="app-footer"><p class="copyright" align="center">&copy; 2017 - 2018 南琴浪博客 <a>(sometimesnaive.org)<a></a></a></p></footer><script src="https://static.sometimesnaive.org:9004/deps/js/function.min.js" type="application/javascript"></script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-108266909-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js" type="application/javascript"></script></body></html><!-- rebuild by neat -->