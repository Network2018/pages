<!-- build time:Sat May 05 2018 01:46:53 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><link href="https://static.sometimesnaive.org:9004/deps/imgs/favicon.ico" type="image/x-icon" rel="icon"><title>Nginx 禁止指定 UA 访问 | 南琴浪博客</title><link href="https://static.sometimesnaive.org:9004/deps/css/style.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/jquery.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/nprogress.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/nprogress.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/prism.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/prism.min.js" type="application/javascript"></script><link href="https://static.sometimesnaive.org:9004/deps/css/gitment.min.css" type="text/css" rel="stylesheet"><script src="https://static.sometimesnaive.org:9004/deps/js/gitment.min.js" type="application/javascript"></script></head><body><header class="header fixed-header"><div class="header-container"><a class="home-link" href="/">南琴浪博客</a><ul class="right-list"><li class="list-item"><a href="/" class="item-link">Home</a></li><li class="list-item"><a href="/archive/" class="item-link">Archive</a></li><li class="list-item"><a href="/portal/atom.xml" class="item-link">RSS</a></li><li class="list-item"><a href="/portal/friendly-links" class="item-link">Links</a></li></ul><div class="menu-mask"><ul class="menu-list"><li class="menu-item"><a href="/" class="menu-link">Home</a></li><li class="menu-item"><a href="/archive/" class="menu-link">Archive</a></li><li class="menu-item"><a href="/portal/atom.xml" class="menu-link">RSS</a></li><li class="menu-item"><a href="/portal/friendly-links" class="menu-link">Links</a></li></ul></div></div></header><div id="article-banner"><h2>Nginx 禁止指定 UA 访问</h2><p class="post-date">03/17/2018</p></div><main class="app-body flex-box"><article class="post-article"><section class="markdown-content"><p>本文介绍 Nginx 禁止指定 UA 访问的配置。<br><a id="more"></a></p><p>UA，即 Http User Agent，在 Nginx 中使用内置变量 $http_user_agent 表示，该信息作为 request header 的一部分被发往 webserver。因此，对 webserver 来说，有一种禁止访问的方式，就是对 UA 进行判断。</p><h2 id="禁止搜索引擎爬虫"><a href="#禁止搜索引擎爬虫" class="headerlink" title="禁止搜索引擎爬虫"></a>禁止搜索引擎爬虫</h2><p>因为你懂的原因，并不是太希望 Baidu 这类爬虫来我的网站，所以在 Nginx 中使用 if 对 UA 进行判断：</p><pre><code class="language-nginx">    if ($http_user_agent ~* &quot;qihoobot|Baidu|Baiduspider|Baiduspider-image|Baiduspider-video|Baiduspider-news|Baiduspider-favo|Baiduspider-cpro|Baiduspider-ads|Baiduboxapp|YisouSpider|EasouSpider|YodaoBot|YoudaoBot|Sosospider|Sogou|^$&quot;) {
        return 444;
    }
</code></pre><h2 id="禁止下载工具"><a href="#禁止下载工具" class="headerlink" title="禁止下载工具"></a>禁止下载工具</h2><pre><code class="language-nginx">    if ($http_user_agent ~* &quot;Scrapy|HttpClient|Curl|Wget|Idm|Aria2|Axel|Thunder|Youtube-dl|Movgrab|rtorrent|ctorrent|Transmission-cli|vuze&quot;) {
        return 444;
    }
</code></pre><h2 id="禁止国产浏览器访问"><a href="#禁止国产浏览器访问" class="headerlink" title="禁止国产浏览器访问"></a>禁止国产浏览器访问</h2><pre><code class="language-nginx">    if ($http_user_agent ~* &quot;360|360SE|360EE|2345Explorer|maxthon|sogou|theworld|qiyu|green|qq|qqbrowser|tt|liebao|lbbrowser|tao|taobao|coolnovo|saayaa|uc|mi|xiaomi|baidu|yandex|micromessenger|wechat|weibo|douban|suning|iqiyi|alipay|ali-ap|ali-ap-pd|ali-am|ali-tb|ali-tb-pd|ali-tm|ali-tm-pd&quot;) {
        return 444;
    }
</code></pre><h2 id="禁止指定系统访问"><a href="#禁止指定系统访问" class="headerlink" title="禁止指定系统访问"></a>禁止指定系统访问</h2><p>也有某些国产系统，例如 aliyun os 这样的，我也想禁止它的访问：</p><pre><code class="language-nginx">    if ($http_user_agent ~* &quot;yunos&quot;) {
        return 444;
    }
</code></pre><h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>根据以上可以看出，要对 UA 进行判断，规则就是：</p><pre><code class="language-nginx">    if ($http_user_agent ~* &quot;UA关键词&quot;) {
        ...
    }
</code></pre><p>不过这种方法缺点很明显，因为 <code>UA 实在太容易伪造了</code>，不过防一下不经伪造的请求（例如国产搜索爬虫）还是可以的。当然也有些更靠谱的方式，例如对 session 的验证。</p></section><br><div class="article-footer"><br><p>本文可能过时失效，若需更新，请留言</p><p>本博客文章均为原创，转载请注明来源</p></div><div class="nav-container"><a class="nav-right" href="/article/61.html">acme - SSL 证书申请脚本 <span class="nav-arrow">→</span> </a><a class="nav-left" href="/article/63.html"><span class="nav-arrow">← </span>传送门：魔改BBR - tcp_nanqinlang 集合</a></div><div id="comments"></div></article><aside class="catalog-container"><div class="toc-main"><strong class="toc-title">Catalog</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#禁止搜索引擎爬虫"><span class="toc-nav-text">禁止搜索引擎爬虫</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#禁止下载工具"><span class="toc-nav-text">禁止下载工具</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#禁止国产浏览器访问"><span class="toc-nav-text">禁止国产浏览器访问</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#禁止指定系统访问"><span class="toc-nav-text">禁止指定系统访问</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#结论"><span class="toc-nav-text">结论</span></a></li></ol></div></aside></main><script>!function(){var e="https://static.sometimesnaive.org:9004/deps/imgs/banner.jpg";$("#article-banner").css({"background-image":"url("+e+")"}),$(".header").removeClass("fixed-header")}()</script><script>(function(){
    var gitmentConfig = "nanqinlang"
    if (gitmentConfig !== 'undefined') {
        var gitment = new Gitment({
            id: "62",
            owner: "nanqinlang",
            repo: "sometimesnaive.org",
            oauth: {client_id: "b0612de512484ab34c7a", client_secret: "c2bc4cd3c947097d2ccc4c16f120d50458314dd0"},
            theme: {render(state, instance){const container = document.createElement('div');container.lang="en-US";container.className='gitment-container gitment-root-container';container.appendChild(instance.renderHeader(state, instance));container.appendChild(instance.renderEditor(state, instance));container.appendChild(instance.renderComments(state, instance));container.appendChild(instance.renderFooter(state, instance));return container;}}
        })
        gitment.render(document.getElementById('comments'))
    }
})();</script><div class="scroll-top"><span class="arrow-icon"></span></div><footer class="app-footer"><p class="copyright" align="center">&copy; 2017 - 2018 南琴浪博客 <a>(sometimesnaive.org)<a></a></a></p></footer><script src="https://static.sometimesnaive.org:9004/deps/js/function.min.js" type="application/javascript"></script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-108266909-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js" type="application/javascript"></script></body></html><!-- rebuild by neat -->